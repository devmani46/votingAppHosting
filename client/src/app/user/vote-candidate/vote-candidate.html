<app-nav-bar></app-nav-bar>

<div class="vote-candidate-page">
  <div class="back-button-container">
    <app-button appearance="outline" shape="circular" (click)="goBack()">
      ← Back to Campaigns
    </app-button>
  </div>

  @if (isLoading()) {
  <div class="loading-container"></div>
  } @else if (campaignNotFound()) {
  <div class="error-container">
    <p class="not-found">Campaign not found.</p>
    <app-button appearance="primary" (click)="goBack()">
      Back to Campaigns
    </app-button>
  </div>
  } @else if (campaign()) {
  <div class="banner-container">
    <img
      class="banner-image"
      [src]="campaign()!.banner_url || '/assets/default-banner.png'"
      alt="Campaign Banner"
    />
  </div>

  <div class="about-campaign">
    <div class="campaign-dates">
      <span class="campaign-start-date"
        ><strong>Start Date: </strong>
        {{ campaign()!.start_date | date : "shortDate" }}</span
      >
      <span class="campaign-end-date"
        ><strong>End Date: </strong
        >{{ campaign()!.end_date | date : "shortDate" }}</span
      >
    </div>
    <h2 class="campaign-title">{{ campaign()!.title }}</h2>
    <p class="description">{{ campaign()!.description }}</p>
  </div>

  <div class="candidate-list">
    @for (candidate of campaign()!.candidates; let i = $index; track i) {
    <div
      class="candidate-wrapper"
      [class.disabled]="hasVoted(campaign()!.id)"
      (click)="hasVoted(campaign()!.id) ? null : openCandidatePopup(i)"
      tabindex="0"
    >
      <app-campaign-card
        [id]="i.toString()"
        [title]="candidate.name"
        [description]="candidate.bio"
        [image]="candidate.photo_url || '/assets/default-user.png'"
        size="medium"
        [disabled]="hasVoted(campaign()!.id)"
      ></app-campaign-card>
    </div>
    }
  </div>
  } @else {
  <p class="not-found">Campaign not found.</p>
  }
</div>

@if (showPopup) {
<div class="popup-backdrop" (click)="closePopup()">
  <div class="popup" (click)="$event.stopPropagation()">
    <p>You have already voted. Only 1 vote per user per campaign.</p>
    <app-button appearance="primary" (click)="closePopup()">OK</app-button>
  </div>
</div>
} @if (candidatePopupOpen) {
<div
  class="detail-backdrop"
  (click)="closeCandidatePopup()"
  aria-modal="true"
  role="dialog"
>
  <div
    class="detail-popup"
    (click)="$event.stopPropagation()"
    tabindex="0"
    aria-label="Candidate details"
  >
    <button
      class="close-btn"
      (click)="closeCandidatePopup()"
      aria-label="Close details"
    >
      ✕
    </button>

    <div class="detail-top">
      <div class="photo-wrap">
        <img
          [src]="activeCandidate()!.photo || '/assets/default-user.png'"
          [alt]="activeCandidate()!.name"
        />
      </div>

      <div class="detail-meta">
        <h3 class="candidate-name">{{ activeCandidate()!.name }}</h3>
        <p class="candidate-bio">{{ activeCandidate()!.bio }}</p>

        <div class="popup-actions">
          <app-button
            appearance="primary"
            (click)="vote(activeIndex()!); $event.stopPropagation()"
            [disabled]="!!(campaign() && hasVoted(campaign()!.id))"
          >
            Vote
          </app-button>
          <app-button appearance="secondary" (click)="closeCandidatePopup()">
            Close
          </app-button>
        </div>
      </div>
    </div>
  </div>
</div>
}

<app-footer></app-footer>
